<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>⚡ CLAUDE // TERMINAL</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          screens: {
            'xs': '480px',
          }
        }
      }
    }
  </script>
  <style>

    :root {
      /* Softer neon colors */
      --neon-cyan: #5ee7df;
      --neon-magenta: #d066e2;
      --neon-purple: #a78bfa;
      --neon-pink: #f472b6;
      --neon-yellow: #fde047;
      --neon-green: #86efac;
      /* Softer backgrounds */
      --crt-bg: #0f172a;
      --crt-dark: #020617;
      --grid-color: rgba(94, 231, 223, 0.02);
      /* UI colors */
      --surface: rgba(15, 23, 42, 0.6);
      --surface-hover: rgba(30, 41, 59, 0.8);
      --border-subtle: rgba(148, 163, 184, 0.1);
      --text-primary: rgba(248, 250, 252, 0.95);
      --text-secondary: rgba(148, 163, 184, 0.8);
      --text-muted: rgba(100, 116, 139, 0.7);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--crt-bg);
      color: var(--neon-cyan);
      overflow: hidden;
    }

    /* Clean background - no CRT effects */
    .crt-screen {
      position: relative;
      background: linear-gradient(180deg, var(--crt-dark) 0%, var(--crt-bg) 100%);
    }

    /* Subtle grain texture only */
    .crt-screen::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='1' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%' height='100%' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 9999;
      opacity: 0.4;
    }

    /* No flicker - removed for cleaner look */

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
      50% { opacity: 1; }
    }

    /* Grid Background */
    .grid-bg {
      background-image:
        linear-gradient(var(--grid-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    /* Typography */
    .font-pixel {
      font-family: 'Press Start 2P', cursive;
    }

    .font-terminal {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .font-code {
      font-family: 'Share Tech Mono', monospace;
    }

    .font-mono {
      font-family: 'VT323', monospace;
    }

    /* Subtle Text Accent - No heavy glow */
    .neon-cyan {
      color: var(--neon-cyan);
    }

    .neon-magenta {
      color: var(--neon-magenta);
    }

    .neon-purple {
      color: var(--neon-purple);
    }

    .neon-pink {
      color: var(--neon-pink);
    }

    .neon-yellow {
      color: var(--neon-yellow);
    }

    .neon-green {
      color: var(--neon-green);
    }

    /* Sidebar Styling */
    .sidebar-panel {
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.95) 0%, rgba(2, 6, 23, 0.98) 100%);
      border-right: 1px solid rgba(94, 231, 223, 0.1);
      position: relative;
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3);
    }

    .sidebar-panel::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 1px;
      background: linear-gradient(180deg, var(--neon-cyan), var(--neon-purple), transparent);
      opacity: 0.3;
    }

    /* Sidebar Section */
    .sidebar-section {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sidebar-section-title {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    /* Session Cards */
    .session-card {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .session-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: transparent;
      transition: background 0.2s;
    }

    .session-card:hover {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .session-card:hover::before {
      background: var(--neon-cyan);
    }

    .session-card.active {
      background: rgba(167, 139, 250, 0.1);
      border-color: rgba(167, 139, 250, 0.3);
    }

    .session-card.active::before {
      background: var(--neon-purple);
    }

    /* Sidebar Tabs */
    .sidebar-tab {
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sidebar-tab:hover {
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.02);
    }

    .sidebar-tab.active {
      color: var(--neon-cyan);
      border-bottom-color: var(--neon-cyan);
    }

    /* Chat Message Styles - Clean & Soft */
    .chat-msg {
      padding: 14px 18px;
      margin-bottom: 12px;
      border-radius: 12px;
      position: relative;
    }

    .chat-msg.user {
      border-right: 3px solid var(--neon-cyan);
      border-left: none;
      background: rgba(94, 231, 223, 0.04);
    }

    .chat-msg.assistant {
      border-left: 3px solid var(--neon-purple);
      background: rgba(167, 139, 250, 0.04);
      margin-right: 0;
    }

    .chat-label {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-label.user {
      color: var(--neon-cyan);
    }

    .chat-label.assistant {
      color: var(--neon-purple);
    }

    .chat-text {
      font-size: 15px;
      line-height: 1.7;
      word-break: break-word;
      color: var(--text-primary);
    }

    .chat-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 10px;
    }

    /* Tool/Thinking/Result - Subtle & Collapsible */
    .msg-tool, .msg-thinking, .msg-result {
      background: var(--surface);
      border-left: 2px solid var(--border-subtle);
      border-radius: 8px;
      margin: 8px 0;
      margin-left: 12px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .msg-tool:hover, .msg-thinking:hover, .msg-result:hover {
      opacity: 1;
    }

    .msg-tool {
      border-left-color: var(--neon-green);
    }

    .msg-thinking {
      border-left-color: var(--neon-yellow);
    }

    .msg-result {
      border-left-color: var(--neon-cyan);
    }

    @media (max-width: 767px) {
      .chat-msg {
        padding: 10px 12px;
        margin-bottom: 6px;
      }

      .chat-msg.user {
        margin-left: 10px;
      }

      .chat-msg.assistant {
        margin-right: 10px;
      }

      .chat-text {
        font-size: 14px;
      }

      .msg-tool, .msg-thinking, .msg-result {
        margin-left: 8px;
        margin-right: 10px;
      }
    }

    /* Scrollbar - Subtle */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb {
      background: var(--border-subtle);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Buttons - Clean */
    .retro-btn {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 500;
      font-size: 13px;
      padding: 8px 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 6px;
    }

    .retro-btn:hover {
      background: var(--surface-hover);
      color: var(--text-primary);
      border-color: var(--neon-cyan);
    }

    /* Input - Clean */
    .retro-input {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      padding: 10px 14px;
      outline: none;
      transition: all 0.2s ease;
      border-radius: 8px;
    }

    .retro-input::placeholder {
      color: var(--text-muted);
    }

    .retro-input:focus {
      border-color: var(--neon-purple);
      background: rgba(167, 139, 250, 0.05);
    }

    /* Stats Badge - Subtle */
    .stat-badge {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      padding: 8px 12px;
      text-align: center;
      border-radius: 8px;
    }

    /* Badge - Minimal */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      font-size: 11px;
      background: var(--surface);
      border-radius: 4px;
      color: var(--text-secondary);
    }

    /* Filter buttons - Subtle */
    .filter-btn {
      color: var(--text-muted);
      border: 1px solid transparent;
      background: transparent;
      transition: all 0.2s;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 500;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 6px;
    }

    .filter-btn:hover {
      color: var(--text-secondary);
      background: var(--surface);
    }

    .filter-btn.active {
      color: var(--neon-purple);
      background: rgba(167, 139, 250, 0.1);
      border-color: transparent;
    }

    /* Toolbar buttons - Icon only */
    .toolbar-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      color: var(--text-muted);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
    }

    .toolbar-btn:hover {
      color: var(--text-primary);
      background: var(--surface);
    }

    .toolbar-btn.active {
      color: var(--neon-purple);
      background: rgba(167, 139, 250, 0.15);
    }

    /* JSON Viewer - Subtle */
    .json-viewer {
      background: var(--surface);
      border-radius: 6px;
    }

    .json-key { color: var(--neon-cyan); opacity: 0.9; }
    .json-string { color: var(--neon-green); opacity: 0.9; }
    .json-number { color: var(--neon-yellow); opacity: 0.9; }
    .json-boolean { color: var(--neon-magenta); opacity: 0.9; }
    .json-null { color: var(--text-muted); }
    .json-bracket { color: var(--text-secondary); }

    /* Collapsible */
    .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .collapsible-content.open { max-height: 2000px; }

    /* Cyber Logo */
    .cyber-logo {
      width: 36px;
      height: 36px;
      position: relative;
      background: linear-gradient(135deg, rgba(94, 231, 223, 0.1), rgba(167, 139, 250, 0.1));
      border: 1px solid rgba(94, 231, 223, 0.3);
      clip-path: polygon(10% 0%, 100% 0%, 100% 90%, 90% 100%, 0% 100%, 0% 10%);
    }

    .cyber-logo::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      right: 2px;
      bottom: 2px;
      background: linear-gradient(135deg, var(--crt-dark), var(--crt-bg));
      clip-path: polygon(10% 0%, 100% 0%, 100% 90%, 90% 100%, 0% 100%, 0% 10%);
    }

    .cyber-logo-inner {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }

    /* Live indicator - Subtle */
    .live-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--neon-green);
      animation: live-pulse 2s ease-in-out infinite;
    }

    @keyframes live-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Fade in */
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Model colors */
    .model-opus { color: var(--neon-yellow); }
    .model-sonnet { color: var(--neon-purple); }
    .model-haiku { color: var(--neon-green); }

    /* Sun decoration (synthwave) */
    .synthwave-sun {
      width: 60px;
      height: 30px;
      background: linear-gradient(180deg,
        var(--neon-yellow) 0%,
        var(--neon-pink) 50%,
        var(--neon-magenta) 100%
      );
      border-radius: 60px 60px 0 0;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }

    .synthwave-sun::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100%;
      background: repeating-linear-gradient(
        0deg,
        transparent 0px,
        transparent 3px,
        rgba(13, 2, 33, 0.8) 3px,
        rgba(13, 2, 33, 0.8) 6px
      );
    }

    /* Mobile Menu Button */
    .menu-btn {
      display: none;
      background: transparent;
      border: 1px solid var(--neon-cyan);
      color: var(--neon-cyan);
      padding: 8px;
      cursor: pointer;
      z-index: 1001;
    }

    /* Sidebar Overlay for Mobile */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 99;
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* Responsive Sidebar */
    .sidebar {
      transition: transform 0.3s ease;
      z-index: 100;
    }

    /* Right Panel */
    .right-panel {
      transition: transform 0.3s ease;
      z-index: 100;
    }

    /* ==================== RESPONSIVE STYLES ==================== */

    /* Mobile First - Base styles for small screens */
    @media (max-width: 767px) {
      .menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .sidebar {
        position: fixed !important;
        top: 0;
        left: 0;
        bottom: 0;
        width: 85%;
        max-width: 320px;
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
        display: flex !important;
      }

      .right-panel {
        position: fixed !important;
        top: 0;
        right: 0;
        bottom: 0;
        width: 85%;
        max-width: 280px;
        transform: translateX(100%);
      }

      .right-panel.open {
        transform: translateX(0);
        display: flex !important;
      }

      .mobile-header {
        display: flex !important;
      }

      /* Main takes full width on mobile */
      main {
        width: 100% !important;
        flex: 1 !important;
      }

      .stat-badge {
        padding: 4px 6px;
      }

      .stat-badge .font-terminal {
        font-size: 18px;
      }

      .stat-badge .font-pixel {
        font-size: 6px;
      }

      .session-card {
        padding: 10px;
      }

      .msg-user, .msg-assistant, .msg-tool, .msg-thinking {
        padding: 12px;
      }

      .font-terminal.text-lg {
        font-size: 16px;
      }

      .synthwave-sun {
        width: 40px;
        height: 20px;
      }
    }

    /* Tablet */
    @media (min-width: 768px) and (max-width: 1023px) {
      .sidebar {
        position: relative !important;
        transform: none !important;
        width: 260px;
        display: flex !important;
      }

      .right-panel {
        position: fixed !important;
        top: 0;
        right: 0;
        bottom: 0;
        width: 280px;
        transform: translateX(100%);
      }

      .right-panel.open {
        display: flex !important;
        transform: translateX(0);
      }

      .menu-btn.right-menu {
        display: flex;
      }

      .mobile-header {
        display: none !important;
      }
    }

    /* Desktop */
    @media (min-width: 1024px) {
      .sidebar {
        position: relative !important;
        transform: none !important;
        width: 280px;
        display: flex !important;
      }

      .right-panel {
        position: relative !important;
        transform: none !important;
        width: 260px;
        display: flex !important;
      }

      .mobile-header {
        display: none !important;
      }
    }

    /* Large Desktop */
    @media (min-width: 1280px) {
      .sidebar {
        width: 300px !important;
      }

      .right-panel {
        width: 280px !important;
      }
    }

    /* Extra Small - Compact Mode */
    @media (max-width: 359px) {
      .font-pixel {
        font-size: 7px !important;
      }

      .badge {
        padding: 2px 4px;
        font-size: 10px;
      }

      .retro-btn {
        font-size: 12px;
        padding: 4px 8px;
      }
    }

    /* Landscape Mobile */
    @media (max-height: 500px) and (orientation: landscape) {
      .stat-badge {
        padding: 3px 6px;
      }

      .p-3 {
        padding: 8px;
      }

      .p-4 {
        padding: 12px;
      }
    }

    /* Bottom Navigation for Mobile */
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, rgba(13, 2, 33, 0.95) 0%, rgba(5, 1, 17, 0.98) 100%);
      border-top: 1px solid var(--neon-purple);
      padding: 8px;
      z-index: 100;
      gap: 8px;
    }

    @media (max-width: 767px) {
      .bottom-nav {
        display: flex;
      }

      #messageContainer {
        padding-bottom: 70px;
      }
    }

    .bottom-nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 8px 4px;
      background: transparent;
      border: 1px solid rgba(185, 103, 255, 0.3);
      color: var(--neon-purple);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 500;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .bottom-nav-btn:hover, .bottom-nav-btn.active {
      border-color: var(--neon-cyan);
      color: var(--neon-cyan);
      background: rgba(0, 255, 249, 0.1);
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <div id="app" class="crt-screen grid-bg flex h-screen">

    <!-- Sidebar -->
    <aside class="sidebar sidebar-panel flex-col relative hidden md:flex" id="sidebar">
      <!-- Close button for mobile -->
      <button class="menu-btn absolute top-2 right-2 md:hidden z-10" onclick="closeSidebar()">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>

      <!-- Header with Logo -->
      <div class="sidebar-section" style="border-bottom: 1px solid rgba(94, 231, 223, 0.15);">
        <div class="flex items-center gap-3">
          <div class="cyber-logo">
            <div class="cyber-logo-inner">
              <i data-lucide="cpu" class="w-4 h-4 text-cyan-400"></i>
            </div>
          </div>
          <div class="flex-1 min-w-0">
            <div class="text-sm font-bold text-white tracking-wide">Claude Dashboard</div>
            <div class="flex items-center gap-1.5 mt-0.5">
              <div class="live-dot" id="connectionDot"></div>
              <span class="text-[10px] text-white/40" id="connectionStatus">Connecting</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Bar -->
      <div class="sidebar-section py-2 flex items-center justify-around text-center">
        <div>
          <div class="text-lg font-bold text-cyan-400" id="statSessions">0</div>
          <div class="text-[10px] text-white/30 uppercase">Sessions</div>
        </div>
        <div class="w-px h-8 bg-white/10"></div>
        <div>
          <div class="text-lg font-bold text-purple-400" id="statTokens">0</div>
          <div class="text-[10px] text-white/30 uppercase">Tokens</div>
        </div>
        <div class="w-px h-8 bg-white/10"></div>
        <div>
          <div class="text-lg font-bold text-pink-400" id="statCost">$0</div>
          <div class="text-[10px] text-white/30 uppercase">Cost</div>
        </div>
      </div>

      <!-- Search -->
      <div class="sidebar-section">
        <div class="relative">
          <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/30"></i>
          <input
            type="text"
            id="searchInput"
            placeholder="Search sessions..."
            class="retro-input w-full text-sm py-2.5 pl-10"
          >
        </div>
      </div>

      <!-- Filter Tabs -->
      <div class="flex border-b border-white/5">
        <button onclick="filterSessions('all')" class="sidebar-tab active flex-1" data-filter="all">All</button>
        <button onclick="filterSessions('today')" class="sidebar-tab flex-1" data-filter="today">Today</button>
        <button onclick="filterSessions('week')" class="sidebar-tab flex-1" data-filter="week">Week</button>
      </div>

      <!-- Session List Header -->
      <div class="px-3 py-2 flex items-center justify-between">
        <span class="sidebar-section-title mb-0">Sessions</span>
        <span class="text-xs text-cyan-400" id="sessionCount">0</span>
      </div>

      <!-- Session List -->
      <div class="flex-1 overflow-y-auto px-2 pb-2 space-y-1.5" id="sessionList">
        <div class="p-4 text-center text-sm text-white/30">
          Loading sessions...
        </div>
      </div>

      <!-- Footer -->
      <div class="sidebar-section border-t border-cyan-500/10" style="border-bottom: none;">
        <button onclick="refreshSessions()" class="retro-btn w-full text-xs py-2.5">
          <span class="flex items-center justify-center gap-2">
            <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
            Refresh Sessions
          </span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative z-10 min-w-0 overflow-hidden">
      <!-- Mobile Header -->
      <div class="mobile-header hidden border-b border-purple-500/30 p-2 bg-black/50 items-center justify-between gap-2">
        <button class="menu-btn" onclick="openSidebar()">
          <i data-lucide="menu" class="w-5 h-5"></i>
        </button>
        <div class="flex-1 min-w-0 text-center">
          <span class="font-pixel text-[8px] neon-cyan">CLAUDE</span>
          <span class="font-terminal text-sm neon-magenta ml-1">TERMINAL</span>
        </div>
        <button class="menu-btn right-menu" onclick="openRightPanel()">
          <i data-lucide="activity" class="w-5 h-5"></i>
        </button>
      </div>

      <!-- Toolbar -->
      <div class="border-b border-white/5 px-3 py-2 flex items-center gap-3 bg-black/20">
        <div id="sessionTitle" class="flex items-center gap-2 min-w-0 flex-1">
          <span class="text-sm text-white/30">Select a session</span>
        </div>
        <div id="sessionMeta" class="hidden sm:flex items-center gap-2 text-xs text-white/40 flex-shrink-0"></div>
        <div class="flex items-center gap-1 flex-shrink-0">
          <button onclick="toggleAutoScroll()" id="autoScrollBtn" class="toolbar-btn" title="Auto scroll">
            <i data-lucide="arrow-down-circle" class="w-4 h-4"></i>
          </button>
          <button onclick="exportSession()" class="toolbar-btn" title="Export">
            <i data-lucide="download" class="w-4 h-4"></i>
          </button>
        </div>
      </div>

      <!-- Tool Summary Bar -->
      <div id="toolSummary" class="hidden border-b border-white/5 px-3 py-1.5 bg-black/10 flex items-center gap-2 flex-wrap text-xs text-white/40">
        <span>Tools:</span>
      </div>

      <!-- Messages -->
      <div class="flex-1 overflow-y-auto overflow-x-hidden p-3 lg:p-4 space-y-2" id="messageContainer">
        <div class="flex items-center justify-center h-full">
          <div class="text-center text-white/30">
            <i data-lucide="message-square" class="w-12 h-12 mx-auto mb-3 opacity-30"></i>
            <div class="text-sm">Select a session to view</div>
          </div>
        </div>
      </div>

      <!-- Stats Bar -->
      <div class="border-t border-white/5 px-3 py-2 flex items-center gap-4 bg-black/20 text-xs text-white/50">
        <span><span class="text-cyan-400" id="msgCount">0</span> messages</span>
        <span><span class="text-purple-400" id="tokenCount">0</span> tokens</span>
        <span><span class="text-green-400" id="toolCount">0</span> tools</span>
        <span class="ml-auto text-white/30" id="modelName">—</span>
      </div>
    </main>

    <!-- Right Panel - Live Updates -->
    <aside class="right-panel retro-panel hidden lg:flex flex-col relative" id="rightPanel">
      <!-- Close button for tablet -->
      <button class="menu-btn absolute top-2 right-2 lg:hidden" onclick="closeRightPanel()">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>

      <div class="p-2 lg:p-3 border-b border-purple-500/30">
        <h2 class="font-pixel text-[8px] lg:text-[9px] tracking-wider flex items-center gap-2">
          <span class="neon-green">⚡</span>
          <span class="text-purple-400">LIVE FEED</span>
        </h2>
      </div>
      <div class="flex-1 overflow-y-auto p-2 space-y-2" id="liveUpdates">
        <div class="text-center py-6">
          <div class="font-terminal text-sm lg:text-lg text-purple-500/50 pulse-neon">AWAITING INPUT...</div>
          <div class="font-pixel text-[6px] text-purple-500/30 mt-2">MONITORING</div>
        </div>
      </div>

      <!-- Decorative Grid -->
      <div class="p-3 border-t border-purple-500/30 hidden lg:block">
        <div class="h-16 relative overflow-hidden opacity-30">
          <div style="
            position: absolute;
            bottom: 0;
            left: -20%;
            right: -20%;
            height: 100%;
            background:
              linear-gradient(90deg, var(--neon-magenta) 1px, transparent 1px),
              linear-gradient(0deg, var(--neon-magenta) 1px, transparent 1px);
            background-size: 15px 15px;
            transform: perspective(100px) rotateX(60deg);
            transform-origin: bottom;
          "></div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Bottom Navigation for Mobile -->
  <nav class="bottom-nav">
    <button class="bottom-nav-btn" onclick="openSidebar()">
      <i data-lucide="list" class="w-5 h-5"></i>
      <span>Sessions</span>
    </button>
    <button class="bottom-nav-btn active">
      <i data-lucide="message-square" class="w-5 h-5"></i>
      <span>Chat</span>
    </button>
    <button class="bottom-nav-btn" onclick="openRightPanel()">
      <i data-lucide="activity" class="w-5 h-5"></i>
      <span>Live</span>
    </button>
    <button class="bottom-nav-btn" onclick="refreshSessions()">
      <i data-lucide="refresh-cw" class="w-5 h-5"></i>
      <span>Refresh</span>
    </button>
  </nav>

  <script>
    // State
    let ws = null;
    let sessions = [];
    let currentSession = null;
    let currentSessionData = null;
    let autoScroll = true;
    let currentFilter = 'all';
    let totalSessions = 0;
    let hasMoreSessions = false;
    let isLoadingMore = false;

    // Mobile Menu Functions
    function openSidebar() {
      document.getElementById('sidebar').classList.add('open');
      document.getElementById('sidebarOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    function openRightPanel() {
      document.getElementById('rightPanel').classList.add('open');
      document.getElementById('sidebarOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeRightPanel() {
      document.getElementById('rightPanel').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    // Close panels on overlay click
    document.getElementById('sidebarOverlay').addEventListener('click', function() {
      closeSidebar();
      closeRightPanel();
    });

    // Handle window resize
    window.addEventListener('resize', function() {
      if (window.innerWidth >= 768) {
        closeSidebar();
        closeRightPanel();
      }
    });

    // WebSocket
    function connect() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);

      ws.onopen = () => {
        document.getElementById('connectionStatus').textContent = 'Online';
        document.getElementById('connectionStatus').className = 'text-xs text-green-400';
        document.getElementById('connectionDot').style.background = 'var(--neon-green)';
      };

      ws.onclose = () => {
        document.getElementById('connectionStatus').textContent = 'Offline';
        document.getElementById('connectionStatus').className = 'text-xs text-red-400';
        document.getElementById('connectionDot').style.background = '#ef4444';
        setTimeout(connect, 3000);
      };

      ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
    }

    function handleMessage(data) {
      switch (data.type) {
        case 'init':
          sessions = data.sessions;
          totalSessions = data.total || data.sessions.length;
          hasMoreSessions = data.hasMore || false;
          renderSessions();
          updateStats();
          break;
        case 'moreSessions':
          // Append new sessions
          sessions = [...sessions, ...data.sessions];
          hasMoreSessions = data.hasMore || false;
          isLoadingMore = false;
          renderSessions();
          break;
        case 'sessionUpdate':
          updateSession(data.session);
          addLiveUpdate(data.session, data.latestEntry);
          break;
        case 'sessionDetails':
          currentSessionData = data.data;
          renderSessionDetails(data.data);
          break;
        case 'refresh':
          refreshSessions();
          break;
      }
    }

    function filterSessions(filter) {
      currentFilter = filter;
      document.querySelectorAll('.sidebar-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      renderSessions();
    }

    function loadMoreSessions() {
      if (isLoadingMore || !hasMoreSessions) return;
      isLoadingMore = true;
      // Request more sessions from server
      ws.send(JSON.stringify({
        type: 'loadMore',
        offset: sessions.length,
        limit: 10
      }));
      // Update button to show loading
      const btn = document.querySelector('.load-more-btn');
      if (btn) {
        btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i><span>กำลังโหลด...</span>`;
        lucide.createIcons();
      }
    }

    function renderSessions() {
      const container = document.getElementById('sessionList');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const weekStart = new Date(todayStart.getTime() - 7 * 24 * 60 * 60 * 1000);

      // Apply client-side filters (search, today, week)
      let filtered = sessions.filter(s => {
        const summary = typeof s.summary === 'string' ? s.summary : '';
        const project = typeof s.project === 'string' ? s.project : '';
        const matchesSearch = summary.toLowerCase().includes(searchTerm) || project.toLowerCase().includes(searchTerm);
        if (!matchesSearch) return false;
        if (currentFilter === 'today') return new Date(s.lastModified) >= todayStart;
        if (currentFilter === 'week') return new Date(s.lastModified) >= weekStart;
        return true;
      });

      // Show count: loaded vs total (if filter is 'all' and no search)
      const isFiltered = currentFilter !== 'all' || searchTerm;
      const countText = isFiltered
        ? `${filtered.length} entries`
        : `${sessions.length} / ${totalSessions} entries`;
      document.getElementById('sessionCount').textContent = countText;

      if (filtered.length === 0) {
        container.innerHTML = `<div class="p-4 text-center text-sm text-white/30">No sessions found</div>`;
        return;
      }

      let html = filtered.map(session => {
        const summary = typeof session.summary === 'string' ? session.summary : 'No summary';
        const isActive = currentSession?.id === session.id;
        const projectName = session.project.split('/').pop() || session.project;
        const model = session.model || '';
        const modelShort = model.includes('opus') ? 'OPUS' : model.includes('sonnet') ? 'SONNET' : model.includes('haiku') ? 'HAIKU' : '';

        return `
          <div class="session-card px-3 py-2 cursor-pointer ${isActive ? 'active' : ''}" onclick="loadSession('${session.projectRaw}', '${session.id}')">
            <div class="flex items-center justify-between gap-2 mb-1">
              <span class="text-xs text-cyan-400 font-medium truncate">${escapeHtml(projectName)}</span>
              <span class="text-[10px] text-white/30 flex-shrink-0">${formatTime(session.lastModified)}</span>
            </div>
            <div class="text-sm text-white/70 line-clamp-2 mb-1.5">${escapeHtml(summary.substring(0, 60))}</div>
            <div class="flex items-center gap-3 text-[10px] text-white/40">
              ${modelShort ? `<span class="text-purple-400">${modelShort}</span>` : ''}
              <span>${session.messageCount} msg</span>
              <span>${formatNumber(session.totalTokens)}</span>
              ${session.toolUses.length > 0 ? `<span>${session.toolUses.length} tools</span>` : ''}
            </div>
          </div>
        `;
      }).join('');

      // Add "Load More" button only if not filtering and there are more sessions on server
      if (!isFiltered && hasMoreSessions) {
        const remaining = totalSessions - sessions.length;
        html += `
          <button onclick="loadMoreSessions()" class="load-more-btn w-full py-2.5 mt-2 text-xs text-cyan-400 hover:text-cyan-300 hover:bg-white/5 rounded-lg border border-white/10 hover:border-cyan-400/30 transition-all flex items-center justify-center gap-2">
            <i data-lucide="chevrons-down" class="w-4 h-4"></i>
            <span>โหลดเพิ่ม (${remaining} รายการ)</span>
          </button>
        `;
      }

      container.innerHTML = html;
      lucide.createIcons();
    }

    function loadSession(projectRaw, sessionId) {
      currentSession = sessions.find(s => s.id === sessionId);
      ws.send(JSON.stringify({ type: 'getSession', projectRaw, sessionId }));
      renderSessions();
      closeSidebar(); // Close sidebar on mobile after selection
    }

    function renderSessionDetails(data) {
      if (!data) {
        document.getElementById('messageContainer').innerHTML = `<div class="flex items-center justify-center h-full"><div class="text-center"><div class="font-pixel text-sm neon-pink mb-4">ERROR: NOT FOUND</div></div></div>`;
        return;
      }

      const projectName = data.project.split('/').pop() || data.project;
      document.getElementById('sessionTitle').innerHTML = `
        <span class="text-sm text-white/90 truncate">${escapeHtml(projectName)}</span>
        <span class="text-xs text-white/30 hidden sm:inline">#${data.sessionId.substring(0, 8)}</span>
      `;

      const thinkingLevel = getThinkingLevel(data.messages);
      const model = data.stats.model || 'unknown';
      const modelShort = model.includes('opus') ? 'Opus' : model.includes('sonnet') ? 'Sonnet' : model.includes('haiku') ? 'Haiku' : model.split('-')[0];

      document.getElementById('sessionMeta').innerHTML = `
        ${thinkingLevel ? `<span class="text-yellow-400">${thinkingLevel}</span>` : ''}
        <span class="text-purple-400">${modelShort}</span>
        <span>${data.stats.messageCount} msg</span>
        <span>${formatNumber(data.stats.totalTokens)}</span>
      `;

      document.getElementById('msgCount').textContent = data.stats.messageCount;
      document.getElementById('tokenCount').textContent = formatNumber(data.stats.totalTokens);
      document.getElementById('toolCount').textContent = data.stats.toolUses.length;
      document.getElementById('modelName').textContent = modelShort;

      const toolBar = document.getElementById('toolSummary');
      if (data.stats.toolUses.length > 0) {
        toolBar.classList.remove('hidden');
        toolBar.innerHTML = `
          <span>Tools:</span>
          ${data.stats.toolUses.slice(0, 6).map(t => `<span class="text-green-400">${escapeHtml(t)}</span>`).join('')}
          ${data.stats.toolUses.length > 6 ? `<span class="text-white/30">+${data.stats.toolUses.length - 6}</span>` : ''}
        `;
      } else {
        toolBar.classList.add('hidden');
      }

      const container = document.getElementById('messageContainer');
      container.innerHTML = renderMessages(data.messages);
      lucide.createIcons();

      if (autoScroll) container.scrollTop = container.scrollHeight;
    }

    function getThinkingLevel(messages) {
      for (const msg of messages) {
        if (msg.raw?.thinkingMetadata?.level) return msg.raw.thinkingMetadata.level;
      }
      return null;
    }

    function renderMessages(messages) {
      const filtered = messages.filter(m =>
        ['user', 'assistant', 'tool_use', 'tool_result'].includes(m.type) ||
        (m.type === 'system' && m.raw?.subtype !== 'stop_hook_summary')
      );
      return filtered.map(msg => renderMessage(msg)).join('');
    }

    function renderMessage(msg) {
      const raw = msg.raw || {};
      if (msg.type === 'system' || msg.type === 'file-history-snapshot') return '';

      if (msg.type === 'user') {
        if (msg.content && typeof msg.content === 'object' && msg.content.type === 'tool_results') {
          return renderAgentResultBlock(msg.content.results, msg.raw, msg.timestamp);
        }
        const content = typeof msg.content === 'string' ? msg.content : '';
        return `
          <div class="chat-msg user fade-in">
            <div class="chat-label user">
              <i data-lucide="user" class="w-3 h-3"></i>
              <span>You</span>
            </div>
            <div class="chat-text whitespace-pre-wrap">${escapeHtml(content)}</div>
            ${msg.timestamp ? `<div class="chat-time">${formatTime(msg.timestamp)}</div>` : ''}
          </div>
        `;
      }

      if (msg.type === 'assistant') {
        const content = raw.message?.content || [];
        let html = '';
        if (Array.isArray(content)) {
          for (const block of content) {
            if (block.type === 'thinking' && block.thinking) html += renderThinkingBlock(block.thinking);
            else if (block.type === 'text' && block.text) html += renderTextBlock(block.text, msg.timestamp);
            else if (block.type === 'tool_use') html += renderToolUseBlock(block);
          }
        } else if (typeof content === 'string') {
          html = renderTextBlock(content, msg.timestamp);
        }
        if (!html && msg.content) html = renderTextBlock(msg.content, msg.timestamp);
        return html;
      }

      if (msg.type === 'tool_use') {
        return renderToolBlock(raw.name || raw.tool || 'Tool', raw.input || raw.arguments || {});
      }

      if (msg.type === 'tool_result') {
        return renderToolResultBlock(msg.content || '');
      }

      return '';
    }

    function renderThinkingBlock(thinking) {
      const preview = thinking.substring(0, 80).replace(/\n/g, ' ');
      const id = 'think-' + Math.random().toString(36).substr(2, 9);
      return `
        <div class="msg-thinking p-3 fade-in cursor-pointer" onclick="toggleThinking('${id}')">
          <div class="flex items-center gap-2">
            <i data-lucide="brain" class="w-4 h-4 text-yellow-400"></i>
            <span class="text-yellow-400 text-sm font-medium">Thinking...</span>
            <i data-lucide="chevron-down" class="w-4 h-4 text-yellow-400/50 ml-auto transition-transform" id="${id}-icon"></i>
          </div>
          <div class="text-xs text-yellow-500/60 mt-1 truncate">${escapeHtml(preview)}...</div>
          <div id="${id}" class="collapsible-content">
            <div class="text-sm text-yellow-200/70 mt-2 whitespace-pre-wrap break-words bg-black/20 p-3 rounded max-h-48 lg:max-h-64 overflow-auto">${escapeHtml(thinking)}</div>
          </div>
        </div>
      `;
    }

    function renderTextBlock(text, timestamp) {
      return `
        <div class="chat-msg assistant fade-in">
          <div class="chat-label assistant">
            <i data-lucide="sparkles" class="w-3 h-3"></i>
            <span>Claude</span>
          </div>
          <div class="chat-text whitespace-pre-wrap">${escapeHtml(text)}</div>
          ${timestamp ? `<div class="chat-time">${formatTime(timestamp)}</div>` : ''}
        </div>
      `;
    }

    function renderToolUseBlock(block) {
      return renderToolBlock(block.name || 'Tool', block.input || {});
    }

    function renderToolBlock(toolName, input) {
      const id = 'json-' + Math.random().toString(36).substr(2, 9);
      const jsonStr = JSON.stringify(input, null, 2);
      const preview = getJsonPreview(input);
      const isLarge = jsonStr.length > 150;

      return `
        <div class="msg-tool p-3 fade-in">
          <div class="flex items-center gap-2 mb-2 text-xs">
            <i data-lucide="terminal" class="w-3 h-3 text-green-400"></i>
            <span class="text-green-400 font-medium">${escapeHtml(toolName)}</span>
          </div>
          <div class="font-code text-xs">
            <div class="p-2 cursor-pointer hover:bg-green-500/5 rounded flex items-center gap-2" onclick="toggleJson('${id}')">
              <span class="text-green-400/60 flex-1 truncate">${escapeHtml(preview)}</span>
              ${isLarge ? `<i data-lucide="chevron-down" class="w-3 h-3 text-green-400/50 transition-transform" id="${id}-icon"></i>` : ''}
            </div>
            ${isLarge ? `<div id="${id}" class="collapsible-content"><div class="p-2 border-t border-green-500/20 max-h-48 overflow-auto">${syntaxHighlight(jsonStr)}</div></div>` : ''}
          </div>
        </div>
      `;
    }

    function renderToolResultBlock(result) {
      const id = 'result-' + Math.random().toString(36).substr(2, 9);
      const isLarge = result.length > 100;
      const preview = result.substring(0, 80).replace(/\n/g, ' ');

      let isJson = false;
      let jsonContent = '';
      try {
        const parsed = JSON.parse(result);
        isJson = true;
        jsonContent = syntaxHighlight(JSON.stringify(parsed, null, 2));
      } catch (e) {
        jsonContent = escapeHtml(result);
      }

      return `
        <div class="msg-result p-3 fade-in">
          <div class="flex items-center gap-2 mb-2 text-xs">
            <i data-lucide="arrow-left" class="w-3 h-3 text-cyan-400/60"></i>
            <span class="text-cyan-400/60">Result</span>
            ${isJson ? '<span class="badge text-cyan-400/80 text-[9px]">JSON</span>' : ''}
          </div>
          <div class="font-code text-xs">
            <div class="p-2 cursor-pointer hover:bg-cyan-500/5 rounded flex items-center gap-2" onclick="toggleJson('${id}')">
              <span class="text-cyan-400/50 flex-1 truncate">${escapeHtml(preview)}${isLarge ? '...' : ''}</span>
              ${isLarge ? `<i data-lucide="chevron-down" class="w-3 h-3 text-cyan-400/50" id="${id}-icon"></i>` : ''}
            </div>
            ${isLarge ? `<div id="${id}" class="collapsible-content"><div class="p-2 border-t border-cyan-500/10 max-h-48 overflow-auto ${isJson ? '' : 'whitespace-pre-wrap'}">${jsonContent}</div></div>` : ''}
          </div>
        </div>
      `;
    }

    function renderAgentResultBlock(results, raw, timestamp) {
      const id = 'agent-' + Math.random().toString(36).substr(2, 9);
      const agentInfo = raw?.toolUseResult || {};
      const agentId = agentInfo.agentId || 'unknown';
      const duration = agentInfo.totalDurationMs ? (agentInfo.totalDurationMs / 1000).toFixed(1) + 's' : '';
      const tokens = agentInfo.totalTokens ? formatNumber(agentInfo.totalTokens) : '';
      const toolCount = agentInfo.totalToolUseCount || 0;
      const fullContent = results.map(r => r.content).join('\n\n');
      const preview = fullContent.substring(0, 100).replace(/\n/g, ' ');
      const isLarge = fullContent.length > 150;

      return `
        <div class="msg-result p-3 fade-in border-l-4 border-l-cyan-400">
          <div class="flex items-center gap-2 flex-wrap mb-2 text-xs">
            <i data-lucide="bot" class="w-3 h-3 text-cyan-400"></i>
            <span class="text-cyan-400 font-medium">Agent</span>
            <span class="text-cyan-400/50">#${escapeHtml(agentId.substring(0, 8))}</span>
            ${duration ? `<span class="text-purple-400/70">${duration}</span>` : ''}
            ${tokens ? `<span class="text-yellow-400/70">${tokens} tok</span>` : ''}
            ${toolCount ? `<span class="text-green-400/70">${toolCount} tools</span>` : ''}
          </div>
          <div class="font-code text-xs">
            <div class="p-2 cursor-pointer hover:bg-cyan-500/5 rounded flex items-center gap-2" onclick="toggleJson('${id}')">
              <span class="text-cyan-400/60 flex-1 truncate">${escapeHtml(preview)}${isLarge ? '...' : ''}</span>
              ${isLarge ? `<i data-lucide="chevron-down" class="w-3 h-3 text-cyan-400/50" id="${id}-icon"></i>` : ''}
            </div>
            ${isLarge ? `<div id="${id}" class="collapsible-content"><div class="p-2 border-t border-cyan-500/10 text-cyan-100/80 whitespace-pre-wrap break-words max-h-48 overflow-auto">${renderMarkdownLite(fullContent)}</div></div>` : `<div class="p-2 text-cyan-100/80 whitespace-pre-wrap break-words">${renderMarkdownLite(fullContent)}</div>`}
          </div>
        </div>
      `;
    }

    function renderMarkdownLite(text) {
      if (typeof text !== 'string') return '';
      return escapeHtml(text)
        .replace(/^### (.+)$/gm, '<div class="font-pixel text-[9px] text-cyan-300 mt-2 mb-1">$1</div>')
        .replace(/^## (.+)$/gm, '<div class="font-pixel text-[10px] text-cyan-200 mt-3 mb-1">$1</div>')
        .replace(/^# (.+)$/gm, '<div class="font-pixel text-[11px] neon-cyan mt-3 mb-2">$1</div>')
        .replace(/\*\*(.+?)\*\*/g, '<strong class="text-white">$1</strong>')
        .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre class="bg-black/50 border border-cyan-500/20 p-2 my-2 text-[10px] overflow-x-auto">$2</pre>')
        .replace(/`([^`]+)`/g, '<code class="bg-black/30 px-1 text-cyan-300">$1</code>')
        .replace(/^- (.+)$/gm, '<div class="pl-2">▸ $1</div>')
        .replace(/\n/g, '<br>');
    }

    function getJsonPreview(obj) {
      if (typeof obj !== 'object' || obj === null) return String(obj);
      const keys = Object.keys(obj);
      if (keys.length === 0) return '{}';
      const previews = keys.slice(0, 2).map(k => {
        const v = obj[k];
        const valPreview = typeof v === 'string' ? `"${v.substring(0, 15)}${v.length > 15 ? '...' : ''}"` :
                           typeof v === 'object' ? (Array.isArray(v) ? `[${v.length}]` : '{...}') : String(v);
        return `${k}: ${valPreview}`;
      });
      return `{ ${previews.join(', ')}${keys.length > 2 ? ', ...' : ''} }`;
    }

    function syntaxHighlight(json) {
      if (typeof json !== 'string') json = JSON.stringify(json, null, 2);
      json = escapeHtml(json);
      return json.replace(
        /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
        function (match) {
          let cls = 'json-number';
          if (/^"/.test(match)) {
            if (/:$/.test(match)) { cls = 'json-key'; match = match.replace(/:$/, '') + '<span class="json-bracket">:</span>'; }
            else { cls = 'json-string'; }
          } else if (/true|false/.test(match)) { cls = 'json-boolean'; }
          else if (/null/.test(match)) { cls = 'json-null'; }
          return `<span class="${cls}">${match}</span>`;
        }
      ).replace(/([{}\[\]])/g, '<span class="json-bracket">$1</span>');
    }

    function toggleJson(id) {
      const el = document.getElementById(id);
      const icon = document.getElementById(id + '-icon');
      if (el) {
        el.classList.toggle('open');
        if (icon) icon.style.transform = el.classList.contains('open') ? 'rotate(180deg)' : '';
      }
    }

    function toggleThinking(id) {
      const el = document.getElementById(id);
      const icon = document.getElementById(id + '-icon');
      el.classList.toggle('open');
      icon.style.transform = el.classList.contains('open') ? 'rotate(180deg)' : '';
    }

    function updateSession(session) {
      const index = sessions.findIndex(s => s.id === session.id);
      if (index >= 0) sessions[index] = session;
      else sessions.unshift(session);
      sessions.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));
      renderSessions();
      updateStats();
      if (currentSession?.id === session.id) loadSession(session.projectRaw, session.id);
    }

    function addLiveUpdate(session, entry) {
      const container = document.getElementById('liveUpdates');
      const summary = typeof session.summary === 'string' ? session.summary : 'Update';
      let entryType = '', entryColor = 'purple';

      if (entry) {
        if (entry.type === 'user') { entryType = 'USER'; entryColor = 'cyan'; }
        else if (entry.type === 'assistant') { entryType = 'CLAUDE'; entryColor = 'purple'; }
        else if (entry.type === 'tool_use') { entryType = entry.name || 'TOOL'; entryColor = 'green'; }
        else { entryType = entry.type.toUpperCase(); }
      }

      const html = `
        <div class="session-card p-2 fade-in">
          <div class="flex items-center gap-2 mb-1">
            <span class="font-pixel text-[7px] neon-${entryColor}">${entryType}://</span>
            <span class="font-terminal text-[10px] text-${entryColor}-500/50 ml-auto">${formatTime(new Date())}</span>
          </div>
          <div class="font-terminal text-xs text-gray-400 truncate">${escapeHtml(summary.substring(0, 35))}</div>
        </div>
      `;

      container.insertAdjacentHTML('afterbegin', html);
      while (container.children.length > 12) container.lastChild.remove();
      lucide.createIcons();
    }

    function updateStats() {
      const totalTokens = sessions.reduce((sum, s) => sum + (s.totalTokens || 0), 0);
      const totalInputTokens = sessions.reduce((sum, s) => sum + (s.totalInputTokens || 0), 0);
      const totalOutputTokens = sessions.reduce((sum, s) => sum + (s.totalOutputTokens || 0), 0);
      const inputCost = (totalInputTokens / 1000000) * 3;
      const outputCost = (totalOutputTokens / 1000000) * 15;
      const totalCost = inputCost + outputCost;

      document.getElementById('statSessions').textContent = sessions.length;
      document.getElementById('statTokens').textContent = formatNumber(totalTokens);
      document.getElementById('statCost').textContent = totalCost < 1 ? `$${totalCost.toFixed(2)}` : `$${totalCost.toFixed(1)}`;
    }

    function refreshSessions() {
      ws.send(JSON.stringify({ type: 'refresh' }));
    }

    function toggleAutoScroll() {
      autoScroll = !autoScroll;
      const btn = document.getElementById('autoScrollBtn');
      btn.classList.toggle('active', autoScroll);
    }

    function exportSession() {
      if (!currentSessionData) return;
      const blob = new Blob([JSON.stringify(currentSessionData, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `claude-session-${currentSessionData.sessionId}.json`;
      a.click();
    }

    function escapeHtml(text) {
      if (typeof text !== 'string') return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatNumber(num) {
      if (!num) return '0';
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    function formatTime(date) {
      const d = new Date(date);
      const now = new Date();
      const diff = now - d;

      // Format time as HH:MM
      const timeStr = d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
      // Format date as D/M
      const dateStr = `${d.getDate()}/${d.getMonth() + 1}`;

      let relative;
      if (diff < 60000) relative = 'now';
      else if (diff < 3600000) relative = Math.floor(diff / 60000) + 'm';
      else if (diff < 86400000) relative = Math.floor(diff / 3600000) + 'h';
      else if (diff < 604800000) relative = Math.floor(diff / 86400000) + 'd';
      else relative = '';

      // Return: "now · 14:30" or "2h · 14:30" or "3d · 5/1 14:30" or "5/1 14:30"
      if (relative && diff < 86400000) {
        return `${relative} · ${timeStr}`;
      } else if (relative) {
        return `${relative} · ${dateStr} ${timeStr}`;
      }
      return `${dateStr} ${timeStr}`;
    }

    // Init
    document.getElementById('searchInput').addEventListener('input', renderSessions);
    connect();
    lucide.createIcons();
  </script>
</body>
</html>
